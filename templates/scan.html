{% extends "base.html" %}
{% block title %}WMS â€” Scan & Link{% endblock %}

{% block extra_head %}
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    .scanner-box { min-height: 300px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
{% endblock %}

{% block content %}
<div class="bg-white rounded-xl shadow-sm ring-1 ring-slate-200 p-6">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-lg font-semibold">Scan &amp; Link</h1>
    <p class="text-sm text-slate-500">First <b>barcode</b>, then <b>location (QR)</b>.</p>
  </div>

  <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
    <!-- BARCODE -->
    <div class="rounded-lg ring-1 ring-slate-200">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-barcode"></i>
          <span class="font-medium">1) Barcode</span>
        </div>
        <div class="flex gap-2 items-center">
          <label class="text-sm text-slate-600">Camera</label>
          <select id="barcodeCamSelect" class="border rounded px-2 py-1 text-sm">
            <option value="">(auto)</option>
          </select>
          <button id="barcodeStart" class="px-3 py-1 rounded bg-indigo-600 text-white text-sm hover:bg-indigo-500">
            <i class="fa-solid fa-play"></i> Start
          </button>
          <button id="barcodeStop" class="px-3 py-1 rounded border text-sm" disabled>
            <i class="fa-solid fa-stop"></i> Stop
          </button>
        </div>
      </div>
      <div class="p-4">
        <div id="barcodeReader" class="scanner-box border rounded mb-3"></div>

        <label class="block text-sm font-medium">Status</label>
        <input id="barcodeStatus" value="Idle" disabled
               class="w-full border rounded px-3 py-2 mb-3 bg-slate-50 text-slate-700" />

        <label class="block text-sm font-medium">Barcode</label>
        <div class="flex gap-2">
          <input id="barcodeInput" placeholder="Scan or type barcode"
                 class="flex-1 border rounded px-3 py-2" />
          <button id="barcodeClear" type="button" class="px-3 py-2 rounded border">Clear</button>
        </div>
        <p class="text-xs text-slate-500 mt-1">Can't start the camera? Enter the barcode manually here.</p>
      </div>
    </div>

    <!-- LOCATION -->
    <div class="rounded-lg ring-1 ring-slate-200">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-location-dot"></i>
          <span class="font-medium">2) Location (QR)</span>
        </div>
        <div class="flex gap-2 items-center">
          <label class="text-sm text-slate-600">Camera</label>
          <select id="locCamSelect" class="border rounded px-2 py-1 text-sm">
            <option value="">(auto)</option>
          </select>
          <button id="locStart" class="px-3 py-1 rounded bg-indigo-600 text-white text-sm hover:bg-indigo-500">
            <i class="fa-solid fa-play"></i> Start
          </button>
          <button id="locStop" class="px-3 py-1 rounded border text-sm" disabled>
            <i class="fa-solid fa-stop"></i> Stop
          </button>
        </div>
      </div>
      <div class="p-4">
        <div id="locReader" class="scanner-box border rounded mb-3"></div>

        <label class="block text-sm font-medium">Status</label>
        <input id="locStatus" value="Idle" disabled
               class="w-full border rounded px-3 py-2 mb-3 bg-slate-50 text-slate-700" />

        <label class="block text-sm font-medium">Location</label>
        <div class="flex gap-2">
          <input id="locInput" placeholder="Scan or type location"
                 class="flex-1 border rounded px-3 py-2" />
          <button id="locClear" type="button" class="px-3 py-2 rounded border">Clear</button>
        </div>
        <p class="text-xs text-slate-500 mt-1">Can't start the camera? Enter the location manually here.</p>
      </div>
    </div>
  </div>

  <!-- LINK BUTTON -->
  <div class="text-right mt-6">
    <form id="linkForm" action="{{ url_for('link_scanned') }}" method="post" class="inline-flex">
      <input type="hidden" name="barcode" id="formBarcode">
      <input type="hidden" name="location" id="formLocation">
      <button id="linkBtn" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-500 disabled:opacity-50"
              type="submit" disabled>
        <i class="fa-solid fa-link"></i> Koppelen
      </button>
    </form>
  </div>
</div>

<!-- Scanning logic -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  // Helpers
  const qs = (s) => document.querySelector(s);
  const setStatus = (el, text) => el.value = text;

  // Elements
  const barcodeStatus = qs("#barcodeStatus");
  const locStatus     = qs("#locStatus");
  const barcodeInput  = qs("#barcodeInput");
  const locInput      = qs("#locInput");
  const linkBtn       = qs("#linkBtn");
  const formBarcode   = qs("#formBarcode");
  const formLocation  = qs("#formLocation");

  function updateLinkState() {
    const ok = barcodeInput.value.trim() && locInput.value.trim();
    linkBtn.disabled = !ok;
    if (ok) {
      formBarcode.value = barcodeInput.value.trim();
      formLocation.value = locInput.value.trim();
    }
  }
  barcodeInput.addEventListener("input", updateLinkState);
  locInput.addEventListener("input", updateLinkState);

  // Camera dropdowns (now <select> instead of Bootstrap dropdown)
  async function fillCameras(selectEl) {
    try {
      const devices = await Html5Qrcode.getCameras();
      if (!devices || devices.length === 0) return;
      devices.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = d.label || d.id;
        selectEl.appendChild(opt);
      });
    } catch (err) {
      console.warn("Camera enumeration failed:", err);
    }
  }

  // Barcode scanner
  let barcodeScanner = null;
  const barcodeReaderId = "barcodeReader";
  const barcodeSelect = qs("#barcodeCamSelect");

  qs("#barcodeStart").addEventListener("click", async () => {
    try {
      if (!barcodeScanner) barcodeScanner = new Html5Qrcode(barcodeReaderId);
      const cfg = { fps: 10, qrbox: 250 };
      const cam = barcodeSelect.value
        ? { deviceId: { exact: barcodeSelect.value } }
        : { facingMode: "environment" };
      await barcodeScanner.start(
        cam, cfg,
        (text) => { barcodeInput.value = text; updateLinkState(); },
        () => {} // ignore scan errors
      );
      setStatus(barcodeStatus, "Camera active");
      qs("#barcodeStop").disabled = false;
    } catch (e) {
      console.error(e);
      setStatus(barcodeStatus, "Camera permission denied or error");
    }
  });

  qs("#barcodeStop").addEventListener("click", async () => {
    if (barcodeScanner && barcodeScanner.isScanning) {
      await barcodeScanner.stop();
      await barcodeScanner.clear();
      setStatus(barcodeStatus, "Stopped");
      qs("#barcodeStop").disabled = true;
    }
  });

  qs("#barcodeClear").addEventListener("click", () => {
    barcodeInput.value = ""; updateLinkState();
  });

  // Location scanner
  let locScanner = null;
  const locReaderId = "locReader";
  const locSelect   = qs("#locCamSelect");

  qs("#locStart").addEventListener("click", async () => {
    try {
      if (!locScanner) locScanner = new Html5Qrcode(locReaderId);
      const cfg = { fps: 10, qrbox: 250 };
      const cam = locSelect.value
        ? { deviceId: { exact: locSelect.value } }
        : { facingMode: "environment" };
      await locScanner.start(
        cam, cfg,
        (text) => { locInput.value = text; updateLinkState(); },
        () => {}
      );
      setStatus(locStatus, "Camera active");
      qs("#locStop").disabled = false;
    } catch (e) {
      console.error(e);
      setStatus(locStatus, "Camera permission denied or error");
    }
  });

  qs("#locStop").addEventListener("click", async () => {
    if (locScanner && locScanner.isScanning) {
      await locScanner.stop();
      await locScanner.clear();
      setStatus(locStatus, "Stopped");
      qs("#locStop").disabled = true;
    }
  });

  qs("#locClear").addEventListener("click", () => {
    locInput.value = ""; updateLinkState();
  });

  // Populate camera selects on load
  fillCameras(barcodeSelect);
  fillCameras(locSelect);
</script>
{% endblock %}
